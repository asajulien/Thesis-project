---
title: "Size and age frequencies"
author: "Asa Julien"
date: "August 2, 2016"
output: html_document
---

##Size and age frequencies, FOLLY BEACH COUNTY PARK
```{r, echo=FALSE}
fbcp.freq <- read.csv("C:\\Users\\juliena\\Desktop\\Data\\Size frequency\\CSV files\\sizeagefreq_fbcp.csv")
library(FSA)
library(nlstools)
library(ggplot2)
library(lattice)
library(dplyr)

std.err<-function(x)
  sd(x)/sqrt(length(x))

length.fbcp <- fbcp.freq$Length.mm
age.fbcp <- fbcp.freq$Growth.bands
quad.fbcp<-fbcp.freq$Quadrat.identifier
date.fbcp<-fbcp.freq$Date.collected
month.code<-fbcp.freq$Month.code

#Histograms
hist(length.fbcp, breaks = 20, main = "August 2016 - February 2017, FBCP", xlab = "Length (mm)", ylab = "Frequency", col = "gray")
hist(age.fbcp, breaks = 20, main = "August 2016 - February 2017, FBCP", xlab = "Length (mm)", ylab = "Frequency", col = "gray")

#ggplot, by month
fbcp.freq$Month.code<-factor(fbcp.freq$Month.code, levels = c("August","September","October","November","December", "January", "February", "March", "April")) #reordering the months

sizeage.plot <- ggplot(data = fbcp.freq, aes(x = Length.mm)) + geom_histogram(binwidth = 5) + facet_grid(~Month.code) + theme_bw() + labs(x = "Length (mm)", y="Frequency")

mn.lines = data.frame(Month.code = c("August", "September", "October", "November", "December", "January", "February", "March", "April"), mn.size = c(81.03, 83.34, 86.32, 87.51, 75.92, 80.25, 85.18)) #visualizing the averages

sizeage.plot + theme(axis.text = element_text(size=16), axis.title = element_text(size = 20,face = "bold"), strip.text = element_text(size = 18, face = "bold")) + geom_vline(aes(xintercept = mn.size), mn.lines) #BEAUTIFUL and you can change binwidths!!! Remember that Aug had 5 samples, vs. 10 in Sep and Oct

#Number of juveniles
juv.month = fbcp.freq %>%
  filter(Length.mm < 30) %>% #Arbitrarily chose 30. Use a more informed size
  group_by(Month.code, Quadrat.identifier) %>%
  summarise(length(Length.mm))

plot(juv.month$`length(Length.mm)` ~ juv.month$Month.code) #n=10 in some cases, 5 in others

#number of mussels by month
nr.mussels = fbcp.freq %>%
  group_by(Month.code, Quadrat.identifier) %>%
  summarise(length(Length.mm))
nr.age = fbcp.freq %>%
  summarise(length(na.omit(Growth.bands)))

```


##Von Bertalanfyy FOLLY BEACH COUNTY PARK
```{r, echo=FALSE}
#von Bertalanffy, FSA package

#get rid of NAs
fbcp.site = fbcp.freq %>%
  select(Quadrat.identifier, Length.mm, Growth.bands) %>%
  na.omit() 

von.length.fbcp <- fbcp.site$Length.mm
von.age.fbcp <- fbcp.site$Growth.bands

#estimating the parameters (L infinity, K, t0)
svTypical.fbcp <- vbStarts(von.length.fbcp ~ von.age.fbcp)
unlist(svTypical.fbcp) 
svTypical.fbcp

svTypical.fbcp <- list(Linf = 113.2532, K = 0.28309, t0 = -0.61066) #using same Linf variable - CAREFUL
svTypical.fbcp

#nls and model

vbTypical.fbcp <- von.length.fbcp~Linf*(1-exp(-K*(von.age.fbcp-t0)))
fitTypical.fbcp <- nls(vbTypical.fbcp,start=svTypical.fbcp)
fitPlot(fitTypical.fbcp, xlab = "Number of growth bands", ylab = "Length (mm)", main = "", cex.axis = 1.2, cex.lab = 1.4, font.lab = 2)
overview(fitTypical.fbcp) #It kind of looks like a cubic function right now...


#CHECK ASSUMPTIONS! Look all right to me
residPlot(fitTypical.fbcp)
hist(residuals(fitTypical.fbcp),main="")

#predict ages for loop

#confidence intervals via bootstrapping
bootTypical.fbcp = nlsBoot(fitTypical.fbcp,niter=999)
confint(bootTypical.fbcp,plot=TRUE)

#confidence interval
ages2plot <- 0:15
fitPlot(fitTypical.fbcp,xlab="Age",ylab="Total Length (mm)",xlim=range(ages2plot),main="")
LCI <- UCI <- numeric(length(ages2plot))

for (i in 1:length(ages2plot)) {
pv <- ests[,"Linf"]*(1-exp(-ests[,"K"]*(ages2plot[i]-ests[,"t0"])))
LCI[i] <- quantile(pv,0.025)
UCI[i] <- quantile(pv,0.975)
}
lines(UCI~ages2plot,type="l",col="blue",lwd=2,lty=2)
lines(LCI~ages2plot,type="l",col="blue",lwd=2,lty=2)


boxplot(von.length.fbcp~von.age.fbcp)
```


#Average ages, sizes by month (subset of data)
```{r, echo=FALSE}


av.age = fbcp.freq %>%
  select(Month.code, Growth.bands) %>%
  group_by(Month.code) %>%
  summarise(mean(na.omit(Growth.bands)))

se.age = fbcp.freq %>%
  select(Month.code, Growth.bands) %>%
  group_by(Month.code) %>%
  summarise(std.err(na.omit(Growth.bands)))


#mean lengths and ages
mn.lengths.fbcp = fbcp.freq %>%
  group_by(Month.code) %>%
  summarise(mean(Length.mm), std.err(Length.mm), mean(na.omit(Growth.bands)), std.err(na.omit(Growth.bands)))
colnames(mn.lengths.fbcp) = c("Month", "Length", "SE.length", "Age", "SE.age")

mn.lengths.fbcp

#plots
mn.lengths.fbcp$Month<-factor(mn.lengths.fbcp$Month, levels = c("August","September","October","November","December", "January", "February", "March", "April")) #Ordering the months

limits.size <- aes(ymax = mn.lengths.fbcp$Length + mn.lengths.fbcp$SE.length, ymin = mn.lengths.fbcp$Length - mn.lengths.fbcp$SE.length)

limits.age = aes(ymax = mn.lengths.fbcp$Age + mn.lengths.fbcp$SE.age, ymin = mn.lengths.fbcp$Age - mn.lengths.fbcp$SE.age)

p.size <- ggplot(mn.lengths.fbcp, aes(Month, Length))
p.size + geom_bar(stat = "identity", width = 0.75) + geom_errorbar(limits.size, width=0.25) + labs(x="Month",y="Length (mm)")

p.age = ggplot(mn.lengths.fbcp, aes(Month, Age))
p.age + geom_bar(stat = "identity", width = 0.75) + geom_errorbar(limits.age, width=0.25) + labs(x="Month",y="Growth bands")
```


#Density FBCP
```{r, echo=FALSE}
den.fbcp = fbcp.freq %>%
  group_by(Month.code, Quadrat.identifier) %>%
  summarise(length(Length.mm))

den.fbcp

density.month<-read.csv("C:\\Users\\juliena\\desktop\\data\\size frequency\\csv files\\density_month_fbcp.csv")

density.month$Month<-factor(density.month$Month, levels = c("August","September","October","November","December", "January", "February", "March", "April")) #Ordering the months

##barplots of average densities:
df.density<-density.month%>%
  group_by(Month)%>%
  summarise(mean(Mussel.density.m..2),std.err(Mussel.density.m..2))
colnames(df.density)<-c("Month","Density","SE.den")

p.density <- ggplot(df.density,aes(x=Month,y=Density),position="dodge")
p.density + geom_bar(stat="identity") + geom_errorbar(aes(ymax=Density+SE.den,ymin=Density-SE.den), width=0.25) + labs(x=expression(Month),y=expression(Density~(individuals~m^{-2}))) + theme(axis.title = element_text(size = 20,face = "bold"), strip.text = element_text(size=18,face = "bold"), axis.text.x = element_text(size=13,face = "bold"), axis.text.y = element_text(size = 13, face = "bold"))

```


----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
