---
title: "Harvesting practices"
author: "Asa Julien"
date: "October 5, 2017"
output: html_document
---

##Biomass
```{r}
library(ggplot2)
library(dplyr)
library(FSA)
library(MASS)

#windows:
biomass = read.csv("C:\\Users\\juliena\\Desktop\\Data\\Harvesting practices\\CSV files\\mass.csv")
#mac:
biomass = read.csv("~/Documents/Ribbed mussel/Data/Harvesting practices/CSV files/mass.csv")

std.err = function(x)
  sd(x)/sqrt(length(x))

biomass = biomass[biomass$Notes != "Wet",]
mass_aov = aov(Weight ~ Treatment + Block, data = biomass)
stepAIC(mass_aov)
detach("package:MASS", unload = T)
mass_aov = aov(log(Weight + 1) ~ Treatment, data = biomass)
summary(mass_aov)
TukeyHSD(mass_aov)
plot(mass_aov)

krusk_mass = kruskal.test(Weight ~ Treatment, data = biomass)
krusk_mass
dunnTest(Weight ~ Treatment, data = biomass)

av_mass = biomass %>%
  group_by(Treatment)%>%
  select(Block, Treatment, Weight) %>%
  summarise(mean(Weight), std.err(Weight))
colnames(av_mass) = c("Treatment", "Wt", "se.wt")
av_mass$Treatment = factor(av_mass$Treatment, levels = c("Control", "Partial", "Full"))

p_mass = ggplot(av_mass, aes(Treatment, Wt))
p_mass + geom_point() + geom_errorbar(aes(ymin = Wt - se.wt, ymax = Wt + se.wt), width = 0.1) + labs(x = "", y = "Weight (g)")

#Conclusion: After a full year, biomass in Full harvest plots was significantly lower than both control and partially harvested plots (ANOVA, Tukey's HSD, and Kruskal test). Partially harvested plots displayed an intermediate response. Samples that were partially damp were removed from analysis.
```

##Stems
```{r}
#windows:
stems = read.csv("C:\\Users\\juliena\\Desktop\\Data\\Harvesting practices\\CSV files\\Stems.csv")
#mac:
stems = read.csv("~/Documents/Ribbed mussel/Data/Harvesting practices/CSV files/Stems.csv")

stems$Treatment = factor(stems$Treatment, levels = c("Control", "Partial", "Full"))

#density

stemdensity = stems %>%
  group_by(Treatment, Block) %>%
  select(Block, Treatment, Length) %>%
  summarise(length(Length))
colnames(stemdensity) = c("Treatment", "Block", "Density")
stemdensity$Treatment = factor(stemdensity$Treatment, levels = c("Control", "Partial", "Full"))

dens_glm = glm(Density ~ Treatment + Block, data = stemdensity, family = "quasipoisson")
summary(dens_glm) #effect of block!
#full is significant, but overdispersion when poisson is used here (residual deviance > degrees of freedom is the rule of thumb). Try family = quasipoisson

stem_mn = stemdensity %>%
  group_by(Treatment) %>%
  summarise(mean(Density), std.err(Density))
colnames(stem_mn) = c("Treatment", "mn_dens", "se_dens")

ggplot(stem_mn, aes(Treatment, mn_dens)) + geom_point() + geom_errorbar(aes(ymin = mn_dens - se_dens, ymax = mn_dens + se_dens), width = 0.1) #Conclusion: While it appears that there is a difference in stem density based on treatment, only the block effect is significant, according to the quasipoisson regression

#length
ln_krusk = kruskal.test(Length ~ Treatment, data = stems)
ln_krusk
dunnTest(Length ~ Treatment, data = stems)

#percentage of larger stems
hist(stems$Length, breaks = 20)
stem_cent = stems %>%
  group_by(Treatment) %>%
  select(Treatment, Length) %>%
  summarise(length(Treatment[Length > 500])/length(Treatment)) #kind of arbitrary

meanln = stems %>%
  group_by(Treatment) %>%
  select(Treatment, Length) %>%
  summarise(mean(Length), std.err(Length), median(Length))
colnames(meanln) = c("Treatment", "Mean_length", "SE_length", "Median_length")

ggplot(meanln, aes(Treatment, Mean_length)) + geom_point() + geom_errorbar(aes(ymin = Mean_length - SE_length, ymax = Mean_length + SE_length), width = 0.1) #means are not a good way to look at length

plot(Length ~ Treatment, xlab = "", ylab = "Length (mm)", data = stems)

#Conclusion: no difference in median stem length between treatments

#%flowering

flowering = stems %>%
  group_by(Treatment, Block) %>%
  select(Block, Treatment, Flowering) %>%
  summarise(sum(Flowering)/length(Flowering))
colnames(flowering) = c("Treatment", "Block", "Flower")
flowering$Treatment = factor(flowering$Treatment, levels = c("Control", "Partial", "Full"))

flower_mn = flowering %>%
  group_by(Treatment) %>%
  summarise(mean(Flower) * 100, std.err(Flower) * 100)
colnames(flower_mn) = c("Treatment", "mn_flower", "se_flower")

ggplot(flower_mn, aes(Treatment, mn_flower)) + geom_point() + geom_errorbar(aes(ymin = mn_flower - se_flower, ymax = mn_flower + se_flower), width = 0.1) + ylab("Percent flowering")

flower_aov = aov(asin(sqrt(Flower)) ~ Treatment + Block, data = flowering) #transformed data
require(MASS)
stepAIC(flower_aov)
detach("package:MASS", unload = T)
flower_aov = aov(asin(sqrt(Flower)) ~ Treatment, data = flowering)
summary(flower_aov)
TukeyHSD(flower_aov)
plot(flower_aov)
#Conclusion: percent of stems flowering is lower in fully harvested plots than in the control. The partial harvest displays an intermediate response.
```

##Recruitment and size
```{r}
#windows:
recruits = read.csv("C:\\Users\\juliena\\Desktop\\Data\\Harvesting practices\\CSV files\\sizeage.csv")
#mac:
recruits = read.csv("~/Documents/Ribbed mussel/Data/Harvesting practices/CSV files/sizeage.csv")

yoty = recruits %>%
  group_by(Block, Treatment) %>%
  select(Block, Treatment, Length, Bands) %>%
  summarise(length(Bands[Bands == "0"]) + length(Bands[Bands == "1"]))
colnames(yoty) = c("Block", "Treatment", "Recruits")
yoty$Treatment = factor(yoty$Treatment, levels = c("Control", "Partial", "Full"))

#could use predicted size based on age to determine who's a recruit (42.9 mm for 1 growth band)

recruits_glm = glm(Recruits ~ Treatment, data = yoty, family = poisson)
summary(recruits_glm) #no overdispersion? or very slight

1 - pchisq(summary(recruits_glm)$deviance, 
           summary(recruits_glm)$df.residual
           )

ggplot(yoty, aes(Recruits, fill = Treatment)) + geom_histogram(binwidth = 0.5, position = "dodge")


with(recruits, hist(Length, breaks = 50))
with(recruits[recruits$Treatment == "Control",], hist(Length, breaks = 50))
with(recruits[recruits$Treatment == "Partial",], hist(Length, breaks = 50))
with(recruits[recruits$Treatment == "Full",], hist(Length, breaks = 50))

#When both 0 and 1-growth band individuals are included in the analysis, there are significant differences in number of recruits between each treatment; controls has the most, full the least. Partial is intermediate. When only age 0 mussels are considered, partial & full harvest become the same essentially (no recruitment, except for 1), and control still has the most recruits
```
