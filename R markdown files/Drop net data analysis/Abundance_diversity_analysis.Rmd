---
title: "Abundance_diversity_analysis"
author: "Asa Julien"
date: "November 30, 2016"
output: html_document
---
##analyzing abundance
```{r, echo=FALSE}
library(car)
library(nlme)
library(lattice)
library(MASS)
library(dplyr)
library(vegan)

#windows:
new_df = read.csv("C:\\users\\juliena\\desktop\\data\\drop net\\csv files\\Diversity_abundance.csv")
legare_net = read.csv("C:\\users\\juliena\\desktop\\data\\drop net\\csv files\\Legare.csv")

#mac:
new_df = read.csv("~/Documents/Ribbed mussel/Data/Drop net/CSV files/Diversity_abundance.csv")
legare_net = read.csv("~/Documents/Ribbed mussel/Data/Drop net/CSV files/Legare.csv")

#species richness:
sp_rich = legare_net %>%
  group_by(Order) %>%
  summarise(length(unique(Species))) #doesn't include traps with zero...

#new_df = new_df[,-7]
#new_df$Abundance = sum(new_df[,seq(8,18)])

new_df$Season = c(rep("Summer 2016", 18), rep("Fall 2016", 32), rep("Winter 2017", 24), rep("Spring 2017", 24), rep("Summer 2017", 12))

#models
test_x = lm(log(Abundance + 1) ~ Treatment * Temperature + CharlestonHeight + Salinity + Pairing, data = new_df) 
summary(test_x)
plot(test_x)

test_y = lm(Richness ~ Treatment * Temperature + CharlestonHeight + Salinity + Pairing, data = new_df) 
summary(test_y)
plot(test_y)

test_z = lm(Shannon ~ Treatment * Temperature + CharlestonHeight + Salinity + Pairing, data = new_df) 
summary(test_z)
plot(test_z)

test_w = lm(Simpson ~ Treatment * Temperature + CharlestonHeight + Salinity + Pairing, data = new_df)
summary(test_w)
plot(test_w)
```


##Multivariate community composition
```{r, echo = FALSE}
#Community composition and direct ordination (trying both RDA and CCA)
marsh = new_df[, c(seq(7, 17))] #All species except for A. heterochaelis

#rda analysis
marsh_rda = rda(sqrt(marsh) ~ Treatment + Temperature + Salinity + CharlestonHeight, data=new_df) #square root transformation makes treatment significant
marsh_rda
plot(marsh_rda)
plot(marsh_rda, display = c('sp', 'cn'))

marsh_rda2 = rda(sqrt(marsh) ~ Treatment + Condition(Temperature) +
                 Condition(Salinity) + Condition(CharlestonHeight),
                 data = new_df)
plot(marsh_rda2, display = c('sp', 'cn')) #ordiplot

anova(marsh_rda, by='margin', permutations = 2000)
RsquareAdj(marsh_rda)

#Just looking at treatment effect
marsh_rda2 = rda(sqrt(marsh) ~ Treatment + Condition(Temperature) + Condition(Salinity) + Condition(CharlestonHeight), data = new_df)

plot(marsh_rda2, display = c('sp', 'cn')) #ordiplot

ordi_plot = ordiplot(marsh_rda, type = "points")
text(ordi_plot, "species", col="blue", cex=1)
points(ordi_plot, "centroids", pch = 19, col = c("blue", "black"), cex = 2)
legend(2, 2, c("Mussels", "No mussels"), col = c("blue", "black"), pch = 19)

anova(marsh_rda2, by = 'margin', permutations = 2000)
RsquareAdj(marsh_rda2) #really low

#cca
#View(new_df[new_df$Abundance == 0,])
marsh_2 = marsh[rowSums(marsh) != 0,]
rowSums(marsh_2)
marsh_cca = cca(marsh_2 ~ Treatment + Temperature + Salinity + CharlestonHeight, data = new_df[-c(11, 62, 63, 65, 66, 68, 70, 93),]) #All rows have to be greater than zero
marsh_cca
plot(marsh_cca, display=  c('sp', 'cn'))
anova(marsh_cca, by = 'margin', permutations = 2000)

ordi_plot2 = ordiplot(marsh_cca, type = "points")
text(ordi_plot, "species", col="blue", cex=1)
points(ordi_plot, "centroids", pch = 19, col = c("blue", "black"), cex = 2)
legend(8, 5, c("Mussels", "No mussels"), col = c("blue", "black"), pch = 19)
```
##end